openapi: 3.0.0
info:
  title: Checkout API
  version: 1.0.0
  description: REST API for handling the checkout process.

servers:
  - url: /api/v1
    description: Base path for Checkout API

tags:
  - name: Customer
    description: Operations for managing customers.
  - name: PurchaseOrder
    description: Operations for managing purchase orders.
  - name: CheckoutTransaction
    description: Read-only operations for viewing checkout transactions.
  - name: BillingInfo
    description: Operations for managing billing information resources.
  - name: ShippingInfo
    description: Operations for managing shipping information resources.

paths:
  # CUSTOMER
  /customers:
    get:
      summary: Returns a list of customers
      operationId: listCustomers
      tags:
        - Customer
      description: Retrieves a paginated list of customers.
      x-spring-paginated: true
      parameters:
        - name: query
          in: query
          description: Free-text search term to filter customers.
          required: false
          schema:
            type: string
      responses:
        '200':
          description: A list of customers.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CustomerPage'
    post:
      summary: Create a new customer
      operationId: createCustomer
      tags:
       - Customer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CustomerCreateRequest'
      responses:
        '201':
          description: Customer created successfully.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Customer'
        '400':
          description: Invalid request payload.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /customers/{id}:
    get:
      summary: Retrieve a customer by its ID
      operationId: getCustomer
      tags:
        - Customer
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Customer found.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Customer'
        '404':
          description: Customer not found.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    patch:
      summary: Partially update a customer
      operationId: updateCustomer
      tags:
        - Customer
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              allOf:
                - $ref: '#/components/schemas/CustomerUpdateRequest'
      responses:
        '200':
          description: Customer updated successfully.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Customer'
        '400':
          description: Invalid request payload.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Customer not found.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  # PURCHASE ORDER
  /purchase-orders:
    post:
      summary: Create a new purchase order
      operationId: createPurchaseOrder
      tags: [ PurchaseOrder ]
      description: |
        Creates a purchase order that defines items and totals used during checkout.
        Order line items are provided in the request; totals are computed server-side.
      requestBody:
        description: Payload to create a purchase order.
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PurchaseOrderCreateRequest'
      responses:
        '201':
          description: Purchase order created successfully.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PurchaseOrder'
        '400':
          description: Invalid request payload.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    get:
      summary: Returns a list of purchase orders
      operationId: listPurchaseOrders
      tags: [ PurchaseOrder ]
      description: Retrieves a paginated list of purchase orders.
      x-spring-paginated: true
      parameters:
        - name: query
          in: query
          description: Free-text search term to filter purchase orders.
          required: false
          schema:
            type: string
      responses:
        '200':
          description: A list of purchase orders.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PurchaseOrderPage'

  /purchase-orders/{id}:
    get:
      summary: Retrieve a purchase order by its ID
      operationId: getPurchaseOrder
      tags: [ PurchaseOrder ]
      parameters:
        - name: id
          in: path
          required: true
          description: UUID of the purchase order to retrieve.
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Purchase order found.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PurchaseOrder'
        '404':
          description: Purchase order not found.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    patch:
      summary: Partially update a purchase order
      operationId: updatePurchaseOrder
      tags: [ PurchaseOrder ]
      description: |
        Partially updates a purchase order. In V1 only "extra" can be updated.
      parameters:
        - name: id
          in: path
          required: true
          description: UUID of the purchase order to update.
          schema:
            type: string
            format: uuid
      requestBody:
        description: Fields to update in the purchase order.
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PurchaseOrderUpdateRequest'
      responses:
        '200':
          description: Purchase order updated successfully.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PurchaseOrder'
        '400':
          description: Invalid request payload.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Purchase order not found.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /purchase-orders/{id}/checkout:
    post:
      summary: Initiate checkout for a purchase order
      operationId: checkoutPurchaseOrder
      tags:
        - PurchaseOrder
      description: |
        Initiates the checkout process for the specified purchase order. The request
        accepts buyer-provided billing and shipping information (if applicable) and a
        payment method code. The service creates an internal checkout transaction and
        forwards the request to the configured payment service provider (PSP).
        The response contains the created checkout transaction and next-action
        instructions (e.g., a redirect URL) required to continue the payment flow.
      parameters:
        - name: id
          in: path
          required: true
          description: UUID of the purchase order to checkout.
          schema:
            type: string
            format: uuid
      requestBody:
        description: Buyer-provided details required to initiate checkout.
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CheckoutRequest'
      responses:
        '200':
          description: Checkout initiated successfully.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CheckoutResponse'
        '400':
          description: Invalid request payload.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Purchase order not found.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '409':
          description: Purchase order is expired or not eligible for checkout.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '502':
          description: Upstream payment service error.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  # CHECKOUT TRANSACTION
  /checkout-transactions:
    get:
      summary: Returns a list of checkout transactions
      operationId: listCheckoutTransactions
      tags:
        - CheckoutTransaction
      description: Retrieves a paginated list of checkout transactions.
      x-spring-paginated: true
      parameters:
        - name: query
          in: query
          description: Free-text search term to filter checkout transactions.
          required: false
          schema:
            type: string
      responses:
        '200':
          description: A list of checkout transactions.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CheckoutTransactionPage'

  /checkout-transactions/{id}:
    get:
      summary: Retrieve a checkout transaction by its ID
      operationId: getCheckoutTransaction
      tags:
        - CheckoutTransaction
      parameters:
        - name: id
          in: path
          required: true
          description: UUID of the checkout transaction to retrieve.
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Checkout transaction found.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CheckoutTransaction'
        '404':
          description: Checkout transaction not found.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  schemas:
    CustomerBase:
      type: object
      additionalProperties: false
      properties:
        firstName:
          type: string
          description: The customer’s last name.
          maxLength: 255
          example: "John"
        lastName:
          type: string
          description:  The customer’s last name.
          maxLength: 255
          example: "Doe"
        email:
          type: string
          format: email
          description: The customer’s email address.
          maxLength: 255
          example: "john.doe@example.com"
        phone:
          type: string
          description: Phone number for billing purposes.
          maxLength: 50
          example: "+1234567890"
        billingInfo:
          allOf:
            - $ref: "#/components/schemas/BillingInfo"
        shippingInfo:
          allOf:
            - $ref: "#/components/schemas/ShippingInfo"
          required:
            - city
            - country
            - address1
            - postalCode
        extra:
          allOf:
            - $ref: '#/components/schemas/Extra'
          x-extra-annotation: "@io.labs64.checkout.validation.ValidExtra"

    Customer:
      type: object
      description: >
        Customer record used to reuse identity, contact, and address information across multiple 
        purchase orders.
      allOf:
        - $ref: '#/components/schemas/CustomerBase'
        - type: object
          properties:
            id:
              type: string
              format: uuid
              readOnly: true
            createdAt:
              type: string
              format: date-time
              readOnly: true
            updatedAt:
              type: string
              format: date-time
              readOnly: true

    CustomerCreateRequest:
      allOf:
        - $ref: '#/components/schemas/CustomerBase'
      required:
        - lastName

    CustomerUpdateRequest:
      allOf:
        - $ref: '#/components/schemas/CustomerBase'

    CustomerPage:
      allOf:
        - $ref: '#/components/schemas/PaginatedResponse'
        - type: object
          properties:
            items:
              type: array
              items:
                $ref: '#/components/schemas/Customer'
              default: [ ]
          required:
            - items

    PurchaseOrderItem:
      type: object
      additionalProperties: false
      properties:
        name:
          type: string
          description: >
            Human-readable name of the item as shown to the buyer in checkout and invoices.
        description:
          type: string
          description: >
            Optional detailed description of the item (used in checkout, emails or invoices).
        url:
          type: string
          format: uri
          description: >
            Optional canonical URL of the item in the merchant system, such as a product page.
        image:
          type: string
          format: uri
          description: >
            Optional primary image for this order line.
            Can be a regular URL (https://...) or a data URL (data:image/png;base64,...).
        sku:
          type: string
          description: >
            Optional stock keeping unit or internal product code used by the merchant.
        uom:
          type: string
          description: >
            Unit of measure for the quantity (e.g. PCS, HOUR, DAY).
        price:
          type: integer
          format: int64
          description: >
            Unit price in minor currency units (e.g. cents) using the purchase order currency.
          minimum: 0
        quantity:
          type: integer
          description: >
            Number of units of this item in the purchase order.
          minimum: 1
        tax:
          allOf:
            - $ref: '#/components/schemas/Tax'
          x-extra-annotation: "@io.labs64.checkout.validation.ValidTaxRate"
        extra:
          allOf:
            - $ref: '#/components/schemas/Extra'
          x-extra-annotation: "@io.labs64.checkout.validation.ValidExtra"
      required:
        - name
        - price
        - quantity

    PurchaseOrderBase:
      type: object
      additionalProperties: false
      x-class-extra-annotation: "@io.labs64.checkout.validation.ValidTimeRange"
      properties:
        currency:
          allOf:
            - $ref: '#/components/schemas/Currency'
          x-extra-annotation: "@io.labs64.checkout.validation.ValidCurrency"
        items:
          type: array
          items:
            $ref: '#/components/schemas/PurchaseOrderItem'
          default: [ ]
        startsAt:
          type: string
          format: date-time
        endsAt:
          type: string
          format: date-time
        extra:
          allOf:
            - $ref: '#/components/schemas/Extra'
          x-extra-annotation: "@io.labs64.checkout.validation.ValidExtra"

    PurchaseOrder:
      description: Purchase order holding items and totals for checkout.
      x-class-extra-annotation: "@io.labs64.checkout.validation.ValidTimeRange"
      allOf:
        - $ref: '#/components/schemas/PurchaseOrderBase'
        - type: object
          properties:
            id:
              type: string
              format: uuid
              readOnly: true
            customer:
              allOf:
                - $ref: '#/components/schemas/Customer'
              readOnly: true
            netAmount:
              type: integer
              format: int64
              readOnly: true
              description: The total amount of all line items, excluding any taxes and shipping, in minor currency units.
            grossAmount:
              type: integer
              format: int64
              readOnly: true
              description: The final total amount (net amount + tax amount + shipping cost) in minor currency units.
            taxAmount:
              type: integer
              format: int64
              readOnly: true
              description: The total amount of tax applied across all line items in the Purchase Order, in minor currency units.
            createdAt:
              type: string
              format: date-time
              readOnly: true
            updatedAt:
              type: string
              format: date-time
              readOnly: true
      required:
        - currency

    PurchaseOrderCreateRequest:
      x-class-extra-annotation: "@io.labs64.checkout.validation.ValidTimeRange"
      allOf:
        - $ref: '#/components/schemas/PurchaseOrderBase'
      properties:
        items:
          type: array
          minItems: 1
          items:
            $ref: '#/components/schemas/PurchaseOrderItem'
          default: [ ]
        customerId:
          type: string
          format: uuid
          description: Optional identifier of the customer associated with this purchase order.
      required:
        - currency
        - items

    PurchaseOrderUpdateRequest:
      type: object
      additionalProperties: false
      description: Only "extra" can be updated.
      properties:
        extra:
          allOf:
            - $ref: '#/components/schemas/Extra'
          x-extra-annotation: "@io.labs64.checkout.validation.ValidExtra"
      required:
        - extra

    PurchaseOrderPage:
      allOf:
        - $ref: '#/components/schemas/PaginatedResponse'
        - type: object
          properties:
            items:
              type: array
              items:
                $ref: '#/components/schemas/PurchaseOrder'
              default: [ ]
          required:
            - items

    BillingInfo:
      type: object
      additionalProperties: false
      properties:
        firstName:
          type: string
          description: First name of the person responsible for billing.
          maxLength: 255
          example: "John"
        lastName:
          type: string
          description: Last name of the person responsible for billing.
          maxLength: 255
          example: "Doe"
        email:
          type: string
          format: email
          description: Email address for billing purposes.
          maxLength: 255
          example: "john.doe@example.com"
        phone:
          type: string
          description: Phone number for billing purposes.
          maxLength: 50
          example: "+1234567890"
        city:
          type: string
          description: City of the billing address.
          maxLength: 100
          example: "New York"
        country:
          type: string
          description: Country code of the billing address in ISO 3166-1 alpha-2 format.
          maxLength: 2
          example: "US"
        address1:
          type: string
          description: Primary street address.
          maxLength: 255
          example: "123 Main St"
        address2:
          type: string
          description: Secondary street address (optional).
          maxLength: 255
          example: "Apt 4B"
        postalCode:
          type: string
          description: ZIP or postal code of the billing address.
          maxLength: 20
          example: "10001"
        state:
          type: string
          description: State or region of the billing address.
          maxLength: 50
          example: "NY"
        vatId:
          type: string
          description: |
            Value Added Tax (VAT) identification number of the company for billing purposes 
                        (e.g., USt-IdNr. in Germany). Required for B2B transactions in the EU.
          example: "DE123456789"

    ShippingInfo:
      type: object
      additionalProperties: false
      properties:
        firstName:
          type: string
          description: First name of the shipment recipient.
          maxLength: 255
          example: "John"
        lastName:
          type: string
          description: Last name of the shipment recipient.
          maxLength: 255
          example: "Doe"
        phone:
          type: string
          description: Recipient phone number (preferably in E.164 format; extensions may be included, e.g., "ext. 123").
          maxLength: 50
          example: "+15687985466"
        city:
          type: string
          description: City of the shipping address.
          maxLength: 100
          example: "New York"
        country:
          type: string
          description: Country code of the shipping address in ISO 3166-1 alpha-2 format.
          maxLength: 2
          example: "US"
        address1:
          type: string
          description: Primary street address.
          maxLength: 255
          example: "123 Main St"
        address2:
          type: string
          description: Secondary street address (optional).
          maxLength: 255
          example: "Apt 4B"
        postalCode:
          type: string
          description: ZIP or postal code of the shipping address.
          maxLength: 20
          example: "10001"
        state:
          type: string
          description: State or region of the shipping address.
          maxLength: 50
          example: "NY"

    CheckoutTransactionStatus:
      type: string
      description: Represents the current state of a checkout transaction.
      enum:
        - PENDING     # Awaiting payment confirmation or further action.
        - FAILED      # The payment attempt failed or was declined.
        - CANCELED    # The transaction was canceled before completion.
        - COMPLETED   # The payment was successfully completed.

    CheckoutTransaction:
      type: object
      description: Represents a checkout transaction created when the buyer submits the purchase.
      properties:
        id:
          type: string
          format: uuid
          readOnly: true
        status:
          allOf:
            - $ref: '#/components/schemas/CheckoutTransactionStatus'
          readOnly: true
        purchaseOrder:
          allOf:
            - $ref: '#/components/schemas/PurchaseOrder'
        billingInfo:
          allOf:
            - $ref: '#/components/schemas/BillingInfo'
        shippingInfo:
          allOf:
            - $ref: '#/components/schemas/ShippingInfo'
        paymentMethod:
          type: string
          description: Code of the selected payment method (e.g., STRIPE).
          example: "STRIPE"
        createdAt:
          type: string
          format: date-time
          readOnly: true
        updatedAt:
          type: string
          format: date-time
          readOnly: true
        closedAt:
          type: string
          format: date-time
          readOnly: true

    CheckoutTransactionPage:
      allOf:
        - $ref: '#/components/schemas/PaginatedResponse'
        - type: object
          properties:
            items:
              type: array
              items:
                $ref: '#/components/schemas/CheckoutTransaction'
              default: [ ]
          required:
            - items

    CheckoutRequest:
      type: object
      description: Payload submitted to initiate checkout for a purchase order.
      properties:
        billingInfo:
          allOf:
            - $ref: '#/components/schemas/BillingInfo'
          required:
            - lastName
        shippingInfo:
          allOf:
            - $ref: '#/components/schemas/ShippingInfo'
          required:
            - lastName
            - city
            - country
            - address1
            - postalCode
        paymentMethod:
          type: string
          description: Code of the selected payment service/provider (e.g., STRIPE).
          example: "STRIPE"
      required:
        - paymentMethod

    CheckoutResponse:
      type: object
      description: Result of initiating checkout, including the created transaction and next-action instructions.
      properties:
        transaction:
          $ref: '#/components/schemas/CheckoutTransaction'
        nextAction:
          $ref: '#/components/schemas/CheckoutNextAction'
      required:
        - transaction
        - nextAction

    CheckoutNextAction:
      type: object
      description: Instruction for the client on how to proceed with the payment flow.
      properties:
        type:
          type: string
          description: Next action that the client must perform.
          enum: [ REDIRECT, NONE ]
          example: REDIRECT
        redirectUrl:
          type: string
          format: uri
          description: URL to redirect the buyer to, if type is REDIRECT.
          example: "https://psp.example.com/redirect/abc123"
        expiresAt:
          type: string
          format: date-time
          description: Optional expiration time for the next action, if provided by the PSP.
      required:
        - type

    Currency:
      type: string
      description: ISO-4217 currency code (3 uppercase letters).
      pattern: '^[A-Z]{3}$'
      example: USD

    TaxRateType:
      type: string
      description: Defines how the tax rate is applied (as a percentage or a fixed amount).
      enum:
        - FIXED
        - PERCENTAGE

    Tax:
      type: object
      description: Structure defining tax information.
      additionalProperties: false
      properties:
        type:
          type: string
          description: Type of tax (e.g., "VAT", "Sales Tax", "GST").
          example: "VAT"
        category:
          type: string
          description: |
            Tax category code (e.g., 'S' for Standard Rate, 'Z' for Zero Rate).
          example: "S"
        rateType:
          description: Type of rate calculation (percentage of price or fixed amount per unit)
          allOf:
            - $ref : '#/components/schemas/TaxRateType'
          default: PERCENTAGE
        rate:
          type: number
          minimum: 0
          description: |
            The tax rate expressed as an integer in "minor units" to avoid floating-point errors. 
            Example:
            - For a 19.00% tax rate in EUR, the value is 1900 (19.00 * 100).
            - For a 5.50% tax rate rate in EUR, the value is 550 (5.50 * 100).
            - For 0%, the value is 0.
      required:
        - rate

    Extra:
      type: object
      description: Custom user-defined fields.
      additionalProperties: true
      example:
        source: "web_portal"
        promoCode: "SUMMER2025"

    ErrorCode:
      type: string
      description: Unique error code identifying the type of error.
      enum:
        - NOT_FOUND         # The requested resource was not found.
        - INTERNAL_ERROR    # An unexpected server-side error occurred.
        - VALIDATION_ERROR  # The request payload failed validation rules.
        - CONFLICT          # Resource conflict (e.g., FK restriction, duplicate, etc.)
        - CONSENT_REQUIRED  # Consent required
        - MISSING_TENANT_ID # Missing header "X-Tenant-Id"
      example: "NOT_FOUND"

    ErrorResponse:
      type: object
      description: Standard error response returned by the Checkout API.
      required:
        - code
        - message
        - timestamp
      properties:
        code:
          $ref: '#/components/schemas/ErrorCode'
        message:
          type: string
          description: Human-readable message describing the error.
          example: "Checkout with ID '550e8400-e29b-41d4-a716-446655440000' was not found."
        timestamp:
          type: string
          format: date-time
          description: Time when the error occurred.
          example: "2025-08-19T12:34:56Z"
        traceId:
          type: string
          description: Optional trace ID for correlating logs or debugging.
          example: "f47ac10b-58cc-4372-a567-0e02b2c3d479"

    PaginatedResponse:
      type: object
      description: Standard pagination envelope used by list endpoints. Contains page cursors and total counters.
      properties:
        page:
          type: integer
          example: 0
        pageSize:
          type: integer
          example: 100
        totalItems:
          type: integer
          format: int64
          example: 1000
        totalPages:
          type: integer
          example: 10
        hasPrev:
          type: boolean
        hasNext:
          type: boolean
      required:
        - page
        - pageSize
        - totalItems
        - totalPages
        - hasPrev
        - hasNext
